/* USER CODE BEGIN Header */
/**
  ******************************************************************************
  * @file           : main.c
  * @brief          : Main program body
  ******************************************************************************
  * @attention
  *
  * <h2><center>&copy; Copyright (c) 2021 STMicroelectronics.
  * All rights reserved.</center></h2>
  *
  * This software component is licensed by ST under BSD 3-Clause license,
  * the "License"; You may not use this file except in compliance with the
  * License. You may obtain a copy of the License at:
  *                        opensource.org/licenses/BSD-3-Clause
  *
  ******************************************************************************
  */
/* USER CODE END Header */
/* Includes ------------------------------------------------------------------*/
#include "main.h"
#include "spi.h"
#include "tim.h"
#include "usart.h"
#include "gpio.h"

/* Private includes ----------------------------------------------------------*/
/* USER CODE BEGIN Includes */
#include "app_tle5012b.h"
#include "Vofa.h"
#include "fw.h"
#include "motor.h"
#include "dwt.h"
#include "math.h"
/* USER CODE END Includes */

/* Private typedef -----------------------------------------------------------*/
/* USER CODE BEGIN PTD */

/* USER CODE END PTD */

/* Private define ------------------------------------------------------------*/
/* USER CODE BEGIN PD */
#define WaveSize 1500
/* USER CODE END PD */

/* Private macro -------------------------------------------------------------*/
/* USER CODE BEGIN PM */

/* USER CODE END PM */

/* Private variables ---------------------------------------------------------*/

/* USER CODE BEGIN PV */
uint8_t Res;//FireWater暂存数据		
Vofa_HandleTypedef jSHandle;//JustFloat框架句柄
DataFrame command_data;//存储串口接收的命令
WavePointer pointer;//存储跟踪曲线的两个下标
Motor motor[4];//存储电机状态
Amp amp;//存储两个轴的幅度
float sin_wave[WaveSize]={0,0.00418877795540388,0.00837748241477061,0.0125660398833526,0.0167543768689814,0.0209424198833570,0.0251300954433375,0.0293173300722283,0.0335040503010715,0.0376901826699345,0.0418756537291996,0.0460603900408522,0.0502443181797696,0.0544273647350091,0.0586094563110965,0.0627905195293134,0.0669704810289849,0.0711492674687669,0.0753268055279327,0.0795030219076598,0.0836778433323155,0.0878511965507432,0.0920230083375471,0.0961932054943776,0.100361714851215,0.104528463267653,0.108693377634185,0.112856384873482,0.117017411941677,0.121176385829651,0.125333233564304,0.129487882209847,0.133640258869072,0.137790290684638,0.141937904840344,0.146083028562412,0.150225589120757,0.154365513830271,0.158502730052093,0.162637165194884,0.166768746716102,0.170897402123277,0.175023058975276,0.179145644883582,0.183265087513560,0.187381314585725,0.191494253877013,0.195603833222048,0.199709980514407,0.203812623707885,0.207911690817759,0.212007109922055,0.216098809162802,0.220186716747302,0.224270760949381,0.228350870110656,0.232426972641784,0.236498997023725,0.240566871808992,0.244630525622907,0.248689887164855,0.252744885209529,0.256795448608188,0.260841506289897,0.264882987262781,0.268919820615266,0.272951935517325,0.276979261221722,0.281001727065251,0.285019262469976,0.289031796944472,0.293039260085057,0.297041581577035,0.301038691195920,0.305030518808678,0.309016994374947,0.312998047948278,0.316973609677352,0.320943609807210,0.324907978680476,0.328866646738583,0.332819544522987,0.336766602676388,0.340707751943952,0.344642923174517,0.348572047321815,0.352495055445678,0.356411878713251,0.360322448400195,0.364226695891898,0.368124552684678,0.372015950386981,0.375900820720587,0.379779095521801,0.383650706742656,0.387515586452103,0.391373666837202,0.395224880204316,0.399069158980295,0.402906435713663,0.406736643075800,0.410559713862128,0.414375580993284,0.418184177516302,0.421985436605783,0.425779291565073,0.429565675827428,0.433344522957187,0.437115766650933,0.440879340738659,0.444635179184927,0.448383216090032,0.452123385691151,0.455855622363500,0.459579860621488,0.463296035119862,0.467004080654855,0.470703932165333,0.474395524733929,0.478078793588192,0.481753674101715,0.485420101795274,0.489078012337956,0.492727341548292,0.496368025395377,0.500000000000000,0.503623201635761,0.507237566730189,0.510843031865860,0.514439533781506,0.518027009373130,0.521605395695108,0.525174629961296,0.528734649546132,0.532285391985734,0.535826794978997,0.539358796388683,0.542881334242517,0.546394346734269,0.549897772224840,0.553391549243344,0.556875616488188,0.560349912828145,0.563814377303427,0.567268949126757,0.570713567684432,0.574148172537390,0.577572703422268,0.580987100252460,0.584391303119172,0.587785252292473,0.591168888222342,0.594542151539713,0.597904983057519,0.601257323771727,0.604599114862375,0.607930297694605,0.611250813819692,0.614560604976064,0.617859613090334,0.621147780278310,0.624425048846016,0.627691361290701,0.630946660301850,0.634190888762189,0.637423989748690,0.640645906533562,0.643856582585254,0.647055961569444,0.650243987350029,0.653420603990105,0.656585755752956,0.659739387103026,0.662881442706895,0.666011867434252,0.669130606358858,0.672237604759516,0.675332808121024,0.678416162135138,0.681487612701520,0.684547105928689,0.687594588134967,0.690630005849423,0.693653305812805,0.696664434978481,0.699663340513365,0.702649969798849,0.705624270431721,0.708586190225086,0.711535677209285,0.714472679632803,0.717397145963179,0.720309024887907,0.723208265315342,0.726094816375592,0.728968627421411,0.731829648029091,0.734677827999341,0.737513117358174,0.740335466357778,0.743144825477394,0.745941145424182,0.748724377134086,0.751494471772696,0.754251380736104,0.756995055651756,0.759725448379305,0.762442511011448,0.765146195874774,0.767836455530597,0.770513242775789,0.773176510643607,0.775826212404519,0.778462301567023,0.781084731878463,0.783693457325840,0.786288432136619,0.788869610779534,0.791436947965386,0.793990398647835,0.796529918024196,0.799055461536220,0.801566984870877,0.804064443961135,0.806547794986732,0.809016994374947,0.811471998801361,0.813912765190618,0.816339250717184,0.818751412806094,0.821149209133704,0.823532597628427,0.825901536471479,0.828255984097604,0.830595899195813,0.832921240710099,0.835231967840167,0.837528040042142,0.839809417029283,0.842076058772692,0.844327925502015,0.846564977706138,0.848787176133882,0.850994481794692,0.853186855959320,0.855364260160507,0.857526656193652,0.859674006117491,0.861806272254755,0.863923417192835,0.866025403784439,0.868112195148239,0.870183754669526,0.872240046000844,0.874281033062634,0.876306680043864,0.878316951402658,0.880311811866920,0.882291226434953,0.884255160376072,0.886203579231215,0.888136448813545,0.890053735209052,0.891955404777151,0.893841424151264,0.895711760239413,0.897566380224798,0.899405251566371,0.901228341999411,0.903035619536087,0.904827052466020,0.906602609356838,0.908362259054731,0.910105970684996,0.911833713652576,0.913545457642601,0.915241172620917,0.916920828834616,0.918584396812554,0.920231847365870,0.921863151588501,0.923478280857682,0.925077206834458,0.926659901464172,0.928226336976963,0.929776485888251,0.931310320999220,0.932827815397294,0.934328942456612,0.935813675838491,0.937281989491892,0.938733857653874,0.940169254850050,0.941588155895030,0.942990535892864,0.944376370237481,0.945745634613117,0.947098304994744,0.948434357648493,0.949753769132067,0.951056516295154,0.952342576279833,0.953611926520976,0.954864544746643,0.956100408978472,0.957319497532067,0.958521789017376,0.959707262339067,0.960875896696899,0.962027671586086,0.963162566797658,0.964280562418815,0.965381638833274,0.966465776721618,0.967532957061630,0.968583161128631,0.969616370495806,0.970632567034527,0.971631732914674,0.972613850604944,0.973578902873160,0.974526872786577,0.975457743712173,0.976371499316945,0.977268123568194,0.978147600733806,0.979009915382530,0.979855052384247,0.980682996910236,0.981493734433433,0.982287250728689,0.983063531873015,0.983822564245833,0.984564334529205,0.985288829708079,0.985996037070505,0.986685944207868,0.987358539015100,0.988013809690895,0.988651744737914,0.989272332962988,0.989875563477316,0.990461425696651,0.991029909341493,0.991581004437262,0.992114701314478,0.992630990608929,0.993129863261835,0.993611310520008,0.994075323936005,0.994521895368273,0.994951016981300,0.995362681245744,0.995756880938569,0.996133609143173,0.996492859249504,0.996834624954185,0.997158900260614,0.997465679479078,0.997754957226847,0.998026728428272,0.998280988314872,0.998517732425420,0.998736956606018,0.998938657010171,0.999122830098858,0.999289472640589,0.999438581711464,0.999570154695225,0.999684189283300,0.999780683474846,0.999859635576780,0.999921044203816,0.999964908278481,0.999991227031138,1,0.999991227031138,0.999964908278481,0.999921044203816,0.999859635576780,0.999780683474846,0.999684189283300,0.999570154695225,0.999438581711464,0.999289472640589,0.999122830098858,0.998938657010171,0.998736956606018,0.998517732425420,0.998280988314872,0.998026728428272,0.997754957226847,0.997465679479078,0.997158900260614,0.996834624954185,0.996492859249504,0.996133609143173,0.995756880938569,0.995362681245744,0.994951016981300,0.994521895368273,0.994075323936005,0.993611310520008,0.993129863261835,0.992630990608929,0.992114701314478,0.991581004437262,0.991029909341493,0.990461425696651,0.989875563477316,0.989272332962988,0.988651744737914,0.988013809690895,0.987358539015100,0.986685944207868,0.985996037070505,0.985288829708079,0.984564334529205,0.983822564245833,0.983063531873016,0.982287250728689,0.981493734433433,0.980682996910236,0.979855052384247,0.979009915382530,0.978147600733806,0.977268123568194,0.976371499316945,0.975457743712173,0.974526872786577,0.973578902873160,0.972613850604944,0.971631732914674,0.970632567034527,0.969616370495806,0.968583161128631,0.967532957061630,0.966465776721618,0.965381638833274,0.964280562418815,0.963162566797658,0.962027671586086,0.960875896696899,0.959707262339067,0.958521789017376,0.957319497532067,0.956100408978472,0.954864544746643,0.953611926520976,0.952342576279833,0.951056516295154,0.949753769132067,0.948434357648493,0.947098304994744,0.945745634613117,0.944376370237481,0.942990535892865,0.941588155895030,0.940169254850050,0.938733857653874,0.937281989491892,0.935813675838491,0.934328942456612,0.932827815397295,0.931310320999220,0.929776485888252,0.928226336976963,0.926659901464172,0.925077206834458,0.923478280857682,0.921863151588501,0.920231847365870,0.918584396812554,0.916920828834617,0.915241172620918,0.913545457642601,0.911833713652576,0.910105970684996,0.908362259054731,0.906602609356838,0.904827052466020,0.903035619536087,0.901228341999412,0.899405251566371,0.897566380224798,0.895711760239413,0.893841424151264,0.891955404777151,0.890053735209053,0.888136448813545,0.886203579231215,0.884255160376072,0.882291226434954,0.880311811866920,0.878316951402658,0.876306680043864,0.874281033062634,0.872240046000844,0.870183754669526,0.868112195148240,0.866025403784439,0.863923417192835,0.861806272254755,0.859674006117491,0.857526656193652,0.855364260160507,0.853186855959321,0.850994481794692,0.848787176133882,0.846564977706138,0.844327925502015,0.842076058772693,0.839809417029283,0.837528040042142,0.835231967840168,0.832921240710100,0.830595899195813,0.828255984097604,0.825901536471479,0.823532597628428,0.821149209133704,0.818751412806095,0.816339250717184,0.813912765190618,0.811471998801361,0.809016994374948,0.806547794986733,0.804064443961135,0.801566984870877,0.799055461536220,0.796529918024196,0.793990398647836,0.791436947965386,0.788869610779534,0.786288432136619,0.783693457325840,0.781084731878463,0.778462301567024,0.775826212404520,0.773176510643607,0.770513242775790,0.767836455530598,0.765146195874774,0.762442511011448,0.759725448379305,0.756995055651757,0.754251380736104,0.751494471772696,0.748724377134086,0.745941145424182,0.743144825477395,0.740335466357778,0.737513117358174,0.734677827999342,0.731829648029091,0.728968627421412,0.726094816375592,0.723208265315342,0.720309024887907,0.717397145963179,0.714472679632804,0.711535677209286,0.708586190225086,0.705624270431721,0.702649969798850,0.699663340513366,0.696664434978481,0.693653305812805,0.690630005849423,0.687594588134968,0.684547105928689,0.681487612701520,0.678416162135138,0.675332808121025,0.672237604759516,0.669130606358858,0.666011867434252,0.662881442706895,0.659739387103026,0.656585755752957,0.653420603990106,0.650243987350029,0.647055961569445,0.643856582585254,0.640645906533562,0.637423989748690,0.634190888762190,0.630946660301850,0.627691361290701,0.624425048846016,0.621147780278311,0.617859613090335,0.614560604976065,0.611250813819692,0.607930297694606,0.604599114862375,0.601257323771727,0.597904983057519,0.594542151539714,0.591168888222342,0.587785252292473,0.584391303119172,0.580987100252460,0.577572703422268,0.574148172537390,0.570713567684432,0.567268949126757,0.563814377303427,0.560349912828145,0.556875616488188,0.553391549243344,0.549897772224840,0.546394346734269,0.542881334242518,0.539358796388684,0.535826794978997,0.532285391985734,0.528734649546132,0.525174629961296,0.521605395695108,0.518027009373131,0.514439533781507,0.510843031865860,0.507237566730189,0.503623201635761,0.500000000000000,0.496368025395377,0.492727341548292,0.489078012337957,0.485420101795274,0.481753674101716,0.478078793588192,0.474395524733930,0.470703932165333,0.467004080654856,0.463296035119862,0.459579860621488,0.455855622363500,0.452123385691151,0.448383216090033,0.444635179184928,0.440879340738659,0.437115766650933,0.433344522957187,0.429565675827429,0.425779291565073,0.421985436605783,0.418184177516302,0.414375580993284,0.410559713862128,0.406736643075800,0.402906435713663,0.399069158980296,0.395224880204317,0.391373666837203,0.387515586452103,0.383650706742657,0.379779095521801,0.375900820720587,0.372015950386982,0.368124552684678,0.364226695891899,0.360322448400195,0.356411878713251,0.352495055445679,0.348572047321815,0.344642923174517,0.340707751943952,0.336766602676389,0.332819544522987,0.328866646738583,0.324907978680477,0.320943609807210,0.316973609677352,0.312998047948278,0.309016994374948,0.305030518808678,0.301038691195921,0.297041581577035,0.293039260085058,0.289031796944472,0.285019262469976,0.281001727065251,0.276979261221723,0.272951935517325,0.268919820615266,0.264882987262781,0.260841506289897,0.256795448608188,0.252744885209530,0.248689887164855,0.244630525622908,0.240566871808992,0.236498997023725,0.232426972641784,0.228350870110656,0.224270760949381,0.220186716747302,0.216098809162802,0.212007109922055,0.207911690817760,0.203812623707885,0.199709980514408,0.195603833222049,0.191494253877014,0.187381314585725,0.183265087513560,0.179145644883583,0.175023058975276,0.170897402123277,0.166768746716103,0.162637165194884,0.158502730052093,0.154365513830271,0.150225589120758,0.146083028562412,0.141937904840345,0.137790290684638,0.133640258869073,0.129487882209847,0.125333233564305,0.121176385829651,0.117017411941678,0.112856384873482,0.108693377634186,0.104528463267654,0.100361714851215,0.0961932054943779,0.0920230083375473,0.0878511965507436,0.0836778433323157,0.0795030219076603,0.0753268055279330,0.0711492674687675,0.0669704810289853,0.0627905195293136,0.0586094563110970,0.0544273647350094,0.0502443181797701,0.0460603900408526,0.0418756537291998,0.0376901826699350,0.0335040503010717,0.0293173300722289,0.0251300954433378,0.0209424198833571,0.0167543768689818,0.0125660398833528,0.00837748241477110,0.00418877795540419,5.66553889764798e-16,-0.00418877795540350,-0.00837748241476997,-0.0125660398833521,-0.0167543768689806,-0.0209424198833564,-0.0251300954433371,-0.0293173300722277,-0.0335040503010711,-0.0376901826699339,-0.0418756537291991,-0.0460603900408519,-0.0502443181797690,-0.0544273647350087,-0.0586094563110958,-0.0627905195293129,-0.0669704810289846,-0.0711492674687663,-0.0753268055279324,-0.0795030219076591,-0.0836778433323150,-0.0878511965507425,-0.0920230083375466,-0.0961932054943772,-0.100361714851214,-0.104528463267653,-0.108693377634184,-0.112856384873481,-0.117017411941677,-0.121176385829650,-0.125333233564304,-0.129487882209846,-0.133640258869072,-0.137790290684637,-0.141937904840344,-0.146083028562411,-0.150225589120756,-0.154365513830271,-0.158502730052092,-0.162637165194883,-0.166768746716102,-0.170897402123276,-0.175023058975276,-0.179145644883582,-0.183265087513559,-0.187381314585724,-0.191494253877012,-0.195603833222048,-0.199709980514406,-0.203812623707884,-0.207911690817759,-0.212007109922054,-0.216098809162802,-0.220186716747301,-0.224270760949381,-0.228350870110655,-0.232426972641783,-0.236498997023724,-0.240566871808991,-0.244630525622907,-0.248689887164854,-0.252744885209529,-0.256795448608187,-0.260841506289896,-0.264882987262780,-0.268919820615265,-0.272951935517325,-0.276979261221722,-0.281001727065251,-0.285019262469976,-0.289031796944471,-0.293039260085057,-0.297041581577034,-0.301038691195920,-0.305030518808677,-0.309016994374947,-0.312998047948278,-0.316973609677351,-0.320943609807209,-0.324907978680476,-0.328866646738583,-0.332819544522986,-0.336766602676388,-0.340707751943951,-0.344642923174516,-0.348572047321815,-0.352495055445678,-0.356411878713250,-0.360322448400194,-0.364226695891898,-0.368124552684678,-0.372015950386981,-0.375900820720586,-0.379779095521801,-0.383650706742656,-0.387515586452103,-0.391373666837202,-0.395224880204316,-0.399069158980295,-0.402906435713662,-0.406736643075800,-0.410559713862127,-0.414375580993284,-0.418184177516301,-0.421985436605782,-0.425779291565072,-0.429565675827428,-0.433344522957187,-0.437115766650932,-0.440879340738658,-0.444635179184927,-0.448383216090032,-0.452123385691150,-0.455855622363499,-0.459579860621487,-0.463296035119861,-0.467004080654855,-0.470703932165332,-0.474395524733929,-0.478078793588192,-0.481753674101715,-0.485420101795273,-0.489078012337956,-0.492727341548291,-0.496368025395376,-0.499999999999999,-0.503623201635760,-0.507237566730189,-0.510843031865859,-0.514439533781506,-0.518027009373130,-0.521605395695107,-0.525174629961295,-0.528734649546131,-0.532285391985734,-0.535826794978996,-0.539358796388683,-0.542881334242517,-0.546394346734269,-0.549897772224840,-0.553391549243344,-0.556875616488188,-0.560349912828144,-0.563814377303426,-0.567268949126756,-0.570713567684431,-0.574148172537389,-0.577572703422267,-0.580987100252459,-0.584391303119172,-0.587785252292473,-0.591168888222342,-0.594542151539713,-0.597904983057519,-0.601257323771726,-0.604599114862374,-0.607930297694605,-0.611250813819691,-0.614560604976064,-0.617859613090334,-0.621147780278310,-0.624425048846015,-0.627691361290700,-0.630946660301849,-0.634190888762189,-0.637423989748689,-0.640645906533561,-0.643856582585253,-0.647055961569444,-0.650243987350028,-0.653420603990105,-0.656585755752956,-0.659739387103026,-0.662881442706895,-0.666011867434251,-0.669130606358858,-0.672237604759515,-0.675332808121024,-0.678416162135138,-0.681487612701519,-0.684547105928688,-0.687594588134967,-0.690630005849423,-0.693653305812804,-0.696664434978480,-0.699663340513365,-0.702649969798849,-0.705624270431720,-0.708586190225086,-0.711535677209285,-0.714472679632803,-0.717397145963178,-0.720309024887907,-0.723208265315342,-0.726094816375592,-0.728968627421411,-0.731829648029091,-0.734677827999341,-0.737513117358174,-0.740335466357778,-0.743144825477394,-0.745941145424182,-0.748724377134086,-0.751494471772696,-0.754251380736104,-0.756995055651756,-0.759725448379304,-0.762442511011447,-0.765146195874774,-0.767836455530597,-0.770513242775789,-0.773176510643607,-0.775826212404519,-0.778462301567023,-0.781084731878463,-0.783693457325839,-0.786288432136619,-0.788869610779534,-0.791436947965386,-0.793990398647835,-0.796529918024196,-0.799055461536219,-0.801566984870876,-0.804064443961134,-0.806547794986732,-0.809016994374947,-0.811471998801361,-0.813912765190618,-0.816339250717183,-0.818751412806094,-0.821149209133704,-0.823532597628427,-0.825901536471479,-0.828255984097604,-0.830595899195812,-0.832921240710099,-0.835231967840167,-0.837528040042141,-0.839809417029283,-0.842076058772692,-0.844327925502015,-0.846564977706137,-0.848787176133881,-0.850994481794692,-0.853186855959320,-0.855364260160507,-0.857526656193652,-0.859674006117491,-0.861806272254755,-0.863923417192835,-0.866025403784439,-0.868112195148239,-0.870183754669526,-0.872240046000844,-0.874281033062633,-0.876306680043863,-0.878316951402657,-0.880311811866920,-0.882291226434953,-0.884255160376072,-0.886203579231215,-0.888136448813544,-0.890053735209052,-0.891955404777150,-0.893841424151264,-0.895711760239413,-0.897566380224797,-0.899405251566371,-0.901228341999411,-0.903035619536087,-0.904827052466019,-0.906602609356838,-0.908362259054731,-0.910105970684996,-0.911833713652576,-0.913545457642601,-0.915241172620917,-0.916920828834616,-0.918584396812554,-0.920231847365870,-0.921863151588500,-0.923478280857682,-0.925077206834458,-0.926659901464172,-0.928226336976963,-0.929776485888251,-0.931310320999220,-0.932827815397294,-0.934328942456612,-0.935813675838491,-0.937281989491891,-0.938733857653874,-0.940169254850050,-0.941588155895030,-0.942990535892864,-0.944376370237481,-0.945745634613117,-0.947098304994744,-0.948434357648493,-0.949753769132067,-0.951056516295154,-0.952342576279833,-0.953611926520976,-0.954864544746643,-0.956100408978472,-0.957319497532067,-0.958521789017376,-0.959707262339067,-0.960875896696898,-0.962027671586086,-0.963162566797658,-0.964280562418815,-0.965381638833274,-0.966465776721617,-0.967532957061630,-0.968583161128631,-0.969616370495806,-0.970632567034527,-0.971631732914674,-0.972613850604943,-0.973578902873160,-0.974526872786577,-0.975457743712173,-0.976371499316945,-0.977268123568193,-0.978147600733806,-0.979009915382530,-0.979855052384247,-0.980682996910236,-0.981493734433433,-0.982287250728689,-0.983063531873015,-0.983822564245833,-0.984564334529205,-0.985288829708079,-0.985996037070505,-0.986685944207868,-0.987358539015100,-0.988013809690895,-0.988651744737914,-0.989272332962988,-0.989875563477316,-0.990461425696651,-0.991029909341493,-0.991581004437262,-0.992114701314478,-0.992630990608929,-0.993129863261835,-0.993611310520008,-0.994075323936005,-0.994521895368273,-0.994951016981300,-0.995362681245744,-0.995756880938569,-0.996133609143172,-0.996492859249504,-0.996834624954185,-0.997158900260614,-0.997465679479078,-0.997754957226847,-0.998026728428272,-0.998280988314872,-0.998517732425420,-0.998736956606018,-0.998938657010171,-0.999122830098858,-0.999289472640589,-0.999438581711464,-0.999570154695225,-0.999684189283300,-0.999780683474846,-0.999859635576780,-0.999921044203816,-0.999964908278481,-0.999991227031138,-1,-0.999991227031138,-0.999964908278481,-0.999921044203816,-0.999859635576781,-0.999780683474846,-0.999684189283300,-0.999570154695225,-0.999438581711464,-0.999289472640589,-0.999122830098858,-0.998938657010171,-0.998736956606018,-0.998517732425420,-0.998280988314872,-0.998026728428272,-0.997754957226847,-0.997465679479078,-0.997158900260614,-0.996834624954185,-0.996492859249504,-0.996133609143173,-0.995756880938569,-0.995362681245744,-0.994951016981300,-0.994521895368273,-0.994075323936005,-0.993611310520009,-0.993129863261835,-0.992630990608929,-0.992114701314478,-0.991581004437262,-0.991029909341493,-0.990461425696651,-0.989875563477316,-0.989272332962988,-0.988651744737914,-0.988013809690895,-0.987358539015101,-0.986685944207868,-0.985996037070505,-0.985288829708079,-0.984564334529205,-0.983822564245833,-0.983063531873016,-0.982287250728689,-0.981493734433433,-0.980682996910236,-0.979855052384247,-0.979009915382530,-0.978147600733806,-0.977268123568194,-0.976371499316945,-0.975457743712173,-0.974526872786577,-0.973578902873160,-0.972613850604944,-0.971631732914674,-0.970632567034528,-0.969616370495806,-0.968583161128631,-0.967532957061630,-0.966465776721618,-0.965381638833274,-0.964280562418815,-0.963162566797658,-0.962027671586086,-0.960875896696899,-0.959707262339067,-0.958521789017376,-0.957319497532068,-0.956100408978473,-0.954864544746643,-0.953611926520976,-0.952342576279833,-0.951056516295154,-0.949753769132067,-0.948434357648493,-0.947098304994745,-0.945745634613117,-0.944376370237481,-0.942990535892865,-0.941588155895030,-0.940169254850050,-0.938733857653874,-0.937281989491892,-0.935813675838491,-0.934328942456612,-0.932827815397295,-0.931310320999220,-0.929776485888252,-0.928226336976964,-0.926659901464173,-0.925077206834458,-0.923478280857683,-0.921863151588501,-0.920231847365871,-0.918584396812554,-0.916920828834617,-0.915241172620918,-0.913545457642601,-0.911833713652576,-0.910105970684996,-0.908362259054731,-0.906602609356838,-0.904827052466020,-0.903035619536088,-0.901228341999412,-0.899405251566371,-0.897566380224798,-0.895711760239413,-0.893841424151264,-0.891955404777151,-0.890053735209053,-0.888136448813545,-0.886203579231215,-0.884255160376072,-0.882291226434954,-0.880311811866921,-0.878316951402658,-0.876306680043864,-0.874281033062634,-0.872240046000844,-0.870183754669526,-0.868112195148240,-0.866025403784439,-0.863923417192836,-0.861806272254755,-0.859674006117492,-0.857526656193653,-0.855364260160507,-0.853186855959321,-0.850994481794692,-0.848787176133882,-0.846564977706138,-0.844327925502016,-0.842076058772693,-0.839809417029283,-0.837528040042142,-0.835231967840168,-0.832921240710100,-0.830595899195813,-0.828255984097605,-0.825901536471479,-0.823532597628428,-0.821149209133704,-0.818751412806095,-0.816339250717185,-0.813912765190618,-0.811471998801361,-0.809016994374948,-0.806547794986733,-0.804064443961135,-0.801566984870877,-0.799055461536221,-0.796529918024197,-0.793990398647836,-0.791436947965386,-0.788869610779534,-0.786288432136619,-0.783693457325840,-0.781084731878464,-0.778462301567024,-0.775826212404520,-0.773176510643608,-0.770513242775790,-0.767836455530598,-0.765146195874775,-0.762442511011448,-0.759725448379305,-0.756995055651757,-0.754251380736104,-0.751494471772697,-0.748724377134087,-0.745941145424183,-0.743144825477395,-0.740335466357779,-0.737513117358175,-0.734677827999342,-0.731829648029092,-0.728968627421412,-0.726094816375593,-0.723208265315342,-0.720309024887908,-0.717397145963179,-0.714472679632804,-0.711535677209286,-0.708586190225087,-0.705624270431722,-0.702649969798850,-0.699663340513366,-0.696664434978482,-0.693653305812805,-0.690630005849424,-0.687594588134968,-0.684547105928690,-0.681487612701520,-0.678416162135139,-0.675332808121025,-0.672237604759516,-0.669130606358859,-0.666011867434252,-0.662881442706896,-0.659739387103027,-0.656585755752957,-0.653420603990106,-0.650243987350029,-0.647055961569445,-0.643856582585255,-0.640645906533562,-0.637423989748690,-0.634190888762190,-0.630946660301850,-0.627691361290701,-0.624425048846017,-0.621147780278311,-0.617859613090335,-0.614560604976065,-0.611250813819693,-0.607930297694606,-0.604599114862375,-0.601257323771727,-0.597904983057520,-0.594542151539714,-0.591168888222343,-0.587785252292474,-0.584391303119173,-0.580987100252460,-0.577572703422268,-0.574148172537391,-0.570713567684432,-0.567268949126757,-0.563814377303428,-0.560349912828145,-0.556875616488189,-0.553391549243345,-0.549897772224840,-0.546394346734270,-0.542881334242518,-0.539358796388684,-0.535826794978997,-0.532285391985735,-0.528734649546133,-0.525174629961296,-0.521605395695108,-0.518027009373131,-0.514439533781507,-0.510843031865860,-0.507237566730190,-0.503623201635762,-0.500000000000000,-0.496368025395378,-0.492727341548292,-0.489078012337957,-0.485420101795275,-0.481753674101716,-0.478078793588193,-0.474395524733930,-0.470703932165333,-0.467004080654856,-0.463296035119862,-0.459579860621489,-0.455855622363501,-0.452123385691152,-0.448383216090033,-0.444635179184928,-0.440879340738660,-0.437115766650933,-0.433344522957188,-0.429565675827429,-0.425779291565074,-0.421985436605783,-0.418184177516302,-0.414375580993285,-0.410559713862129,-0.406736643075801,-0.402906435713664,-0.399069158980296,-0.395224880204317,-0.391373666837203,-0.387515586452104,-0.383650706742657,-0.379779095521802,-0.375900820720588,-0.372015950386982,-0.368124552684679,-0.364226695891899,-0.360322448400195,-0.356411878713251,-0.352495055445679,-0.348572047321816,-0.344642923174518,-0.340707751943952,-0.336766602676389,-0.332819544522987,-0.328866646738584,-0.324907978680477,-0.320943609807211,-0.316973609677352,-0.312998047948279,-0.309016994374949,-0.305030518808678,-0.301038691195921,-0.297041581577036,-0.293039260085059,-0.289031796944472,-0.285019262469977,-0.281001727065252,-0.276979261221723,-0.272951935517326,-0.268919820615267,-0.264882987262781,-0.260841506289898,-0.256795448608189,-0.252744885209531,-0.248689887164855,-0.244630525622908,-0.240566871808993,-0.236498997023725,-0.232426972641785,-0.228350870110657,-0.224270760949382,-0.220186716747302,-0.216098809162803,-0.212007109922056,-0.207911690817760,-0.203812623707886,-0.199709980514408,-0.195603833222049,-0.191494253877014,-0.187381314585726,-0.183265087513561,-0.179145644883583,-0.175023058975277,-0.170897402123278,-0.166768746716103,-0.162637165194884,-0.158502730052094,-0.154365513830272,-0.150225589120758,-0.146083028562413,-0.141937904840346,-0.137790290684639,-0.133640258869073,-0.129487882209848,-0.125333233564306,-0.121176385829651,-0.117017411941678,-0.112856384873483,-0.108693377634186,-0.104528463267654,-0.100361714851216,-0.0961932054943781,-0.0920230083375479,-0.0878511965507442,-0.0836778433323167,-0.0795030219076604,-0.0753268055279336,-0.0711492674687680,-0.0669704810289854,-0.0627905195293142,-0.0586094563110975,-0.0544273647350104,-0.0502443181797702,-0.0460603900408531,-0.0418756537292008,-0.0376901826699351,-0.0335040503010723,-0.0293173300722294,-0.0251300954433379,-0.0209424198833577,-0.0167543768689823,-0.0125660398833538,-0.00837748241477123,-0.00418877795540475};
/*************************************
中间X――59590    Y――48994
X轴（从正到负）    65452――53856   
Y轴（从正到负）		 56386――41790 
*************************************/
Angle angle;
extern PID_parameter PID1_X;//用于追踪轨迹
extern PID_parameter PID1_Y;
extern PID_parameter PID2_X;//用于快速恢复中点
extern PID_parameter PID2_Y;
/* USER CODE END PV */

/* Private function prototypes -----------------------------------------------*/
void SystemClock_Config(void);
/* USER CODE BEGIN PFP */
void PendulumInit(void);//初始化风力摆
void PID_init(void);
/* USER CODE END PFP */

/* Private user code ---------------------------------------------------------*/
/* USER CODE BEGIN 0 */


/* USER CODE END 0 */

/**
  * @brief  The application entry point.
  * @retval int
  */
int main(void)
{
  /* USER CODE BEGIN 1 */


  /* USER CODE END 1 */

  /* MCU Configuration--------------------------------------------------------*/

  /* Reset of all peripherals, Initializes the Flash interface and the Systick. */
  HAL_Init();

  /* USER CODE BEGIN Init */

  /* USER CODE END Init */

  /* Configure the system clock */
  SystemClock_Config();

  /* USER CODE BEGIN SysInit */

  /* USER CODE END SysInit */

  /* Initialize all configured peripherals */
  MX_GPIO_Init();
  MX_TIM2_Init();
  MX_TIM3_Init();
  MX_SPI1_Init();
  MX_SPI2_Init();
  MX_USART1_UART_Init();
  /* USER CODE BEGIN 2 */
	HAL_TIM_PWM_Start(&htim2, TIM_CHANNEL_1);//开启PWM
	HAL_TIM_PWM_Start(&htim2, TIM_CHANNEL_2);
	HAL_TIM_PWM_Start(&htim2, TIM_CHANNEL_3);
	HAL_TIM_PWM_Start(&htim2, TIM_CHANNEL_4);
	HAL_UART_Receive_IT(&huart1, &Res, 1);
	fw_init();//初始化FireWater，接收
	Vofa_Init(&jSHandle,VOFA_MODE_SKIP);//初始化vofa，用JustFloat，发送
	dwt_init();
	command_data.mode=4;//初始化为停止
	PID_init();
	//PendulumInit();
	angle.Mid_X= 59590;
	angle.Mid_Y=48994;
	HAL_GPIO_WritePin(LED_GPIO_Port,LED_Pin,0);
	HAL_TIM_Base_Start_IT(&htim3);//开启定时器中断1ms,定时器最后初始化,防止初始化其他外设失败
  /* USER CODE END 2 */

  /* Infinite loop */
  /* USER CODE BEGIN WHILE */
	int i=0;
  while (1)
  {
		int a,b;
		a=dwt_getCycles();
//		for(int i =0;i<900;i++){//测试代码所用时间,实测每一次float加法只需要7.5ns,double加法需要10ns(core:400MHz)
//			angle[0]+=angle[1];
//		}
		b=dwt_getCycles();
//		float ang[6];
//		ang[0]=angle.X;
//		ang[1]=angle.Y;
//		ang[2]=motor[0].pwm;
//		ang[3]=motor[1].pwm;
//		ang[4]=motor[2].pwm;
//		ang[5]=motor[3].pwm;
//		Vofa_JustFloat(&jSHandle,ang,6);
		//Vofa_Printf(&jSHandle,"%d\r\n",b-a);
		//float c=(float)sin_wave[i];
//		i+=5;
//		if(i>=9999) i=0;
//		Vofa_JustFloat(&jSHandle,&sin_wave[i],1);
		//motor_ctl(4,1,100);
			float ang[8];
			ang[0]=angle.X;
			ang[1]=angle.Y;
			ang[2]=sin_wave[pointer.p_x]*amp.AX+angle.Mid_X;
			ang[3]=sin_wave[pointer.p_y]*amp.AY+angle.Mid_Y;
			ang[4]=motor[0].pwm;
			ang[5]=PID1_X.Intergral;
			ang[6]=amp.AX;
			ang[7]=angle.X-sin_wave[pointer.p_x]*amp.AX-angle.Mid_X;
			Vofa_JustFloat(&jSHandle,ang,8);
			fw_task();
    /* USER CODE END WHILE */

    /* USER CODE BEGIN 3 */
  }
  /* USER CODE END 3 */
}

/**
  * @brief System Clock Configuration
  * @retval None
  */
void SystemClock_Config(void)
{
  RCC_OscInitTypeDef RCC_OscInitStruct = {0};
  RCC_ClkInitTypeDef RCC_ClkInitStruct = {0};

  /** Supply configuration update enable
  */
  HAL_PWREx_ConfigSupply(PWR_LDO_SUPPLY);
  /** Configure the main internal regulator output voltage
  */
  __HAL_PWR_VOLTAGESCALING_CONFIG(PWR_REGULATOR_VOLTAGE_SCALE1);

  while(!__HAL_PWR_GET_FLAG(PWR_FLAG_VOSRDY)) {}
  /** Initializes the RCC Oscillators according to the specified parameters
  * in the RCC_OscInitTypeDef structure.
  */
  RCC_OscInitStruct.OscillatorType = RCC_OSCILLATORTYPE_HSE;
  RCC_OscInitStruct.HSEState = RCC_HSE_ON;
  RCC_OscInitStruct.PLL.PLLState = RCC_PLL_ON;
  RCC_OscInitStruct.PLL.PLLSource = RCC_PLLSOURCE_HSE;
  RCC_OscInitStruct.PLL.PLLM = 3;
  RCC_OscInitStruct.PLL.PLLN = 96;
  RCC_OscInitStruct.PLL.PLLP = 2;
  RCC_OscInitStruct.PLL.PLLQ = 4;
  RCC_OscInitStruct.PLL.PLLR = 2;
  RCC_OscInitStruct.PLL.PLLRGE = RCC_PLL1VCIRANGE_3;
  RCC_OscInitStruct.PLL.PLLVCOSEL = RCC_PLL1VCOWIDE;
  RCC_OscInitStruct.PLL.PLLFRACN = 0;
  if (HAL_RCC_OscConfig(&RCC_OscInitStruct) != HAL_OK)
  {
    Error_Handler();
  }
  /** Initializes the CPU, AHB and APB buses clocks
  */
  RCC_ClkInitStruct.ClockType = RCC_CLOCKTYPE_HCLK|RCC_CLOCKTYPE_SYSCLK
                              |RCC_CLOCKTYPE_PCLK1|RCC_CLOCKTYPE_PCLK2
                              |RCC_CLOCKTYPE_D3PCLK1|RCC_CLOCKTYPE_D1PCLK1;
  RCC_ClkInitStruct.SYSCLKSource = RCC_SYSCLKSOURCE_PLLCLK;
  RCC_ClkInitStruct.SYSCLKDivider = RCC_SYSCLK_DIV1;
  RCC_ClkInitStruct.AHBCLKDivider = RCC_HCLK_DIV2;
  RCC_ClkInitStruct.APB3CLKDivider = RCC_APB3_DIV2;
  RCC_ClkInitStruct.APB1CLKDivider = RCC_APB1_DIV2;
  RCC_ClkInitStruct.APB2CLKDivider = RCC_APB2_DIV2;
  RCC_ClkInitStruct.APB4CLKDivider = RCC_APB4_DIV2;

  if (HAL_RCC_ClockConfig(&RCC_ClkInitStruct, FLASH_LATENCY_2) != HAL_OK)
  {
    Error_Handler();
  }
}

/* USER CODE BEGIN 4 */
/**
  * @brief Initialize the pendulum, make sure it is stablized to the mid-point
  * @retval None
  * @author Francolin
  */
void PendulumInit(void){
	int i=0;
	while(i<=50){
		if(ReadSpeed()<5&&ReadSpeed_Y()<5){
			i++;
			HAL_Delay(100);
			float m = ReadSpeed();
			Vofa_JustFloat(&jSHandle,&m,1);
			HAL_GPIO_TogglePin(LED_GPIO_Port, LED_Pin);
		}
		else{
			i=0;
			HAL_Delay(100);
			float m = ReadSpeed();
			Vofa_JustFloat(&jSHandle,&m,1);
			HAL_GPIO_TogglePin(LED_GPIO_Port, LED_Pin);
		}
	}
}
void PID_init(void){
	PID1_X.Kp = 15;
	PID1_X.Ki = 0;
	PID1_X.Kd = 800;
	PID1_X.Intergral_max = 1000;
	PID1_X.Output_max=9999;
	
	PID1_Y.Kp = 15;
	PID1_Y.Ki = 0;
	PID1_Y.Kd = 800;
	PID1_Y.Intergral_max = 1000;
	PID1_Y.Output_max=9999;

	PID2_X.Kp = 1;
	PID2_X.Ki = 0;
	PID2_X.Kd = 1.0;
	PID2_X.Intergral_max = 2000;
	PID2_X.Output_max=9999;
	
	PID2_Y.Kp = 1;
	PID2_Y.Ki = 0;
	PID2_Y.Kd = 1.0;
	PID2_Y.Intergral_max = 2000;
	PID2_Y.Output_max=9999;
}
/* USER CODE END 4 */

/**
  * @brief  This function is executed in case of error occurrence.
  * @retval None
  */
void Error_Handler(void)
{
  /* USER CODE BEGIN Error_Handler_Debug */
  /* User can add his own implementation to report the HAL error return state */
  __disable_irq();
  while (1)
  {
		Vofa_Printf(&jSHandle,"ERROR!\r\n");
  }
  /* USER CODE END Error_Handler_Debug */
}

#ifdef  USE_FULL_ASSERT
/**
  * @brief  Reports the name of the source file and the source line number
  *         where the assert_param error has occurred.
  * @param  file: pointer to the source file name
  * @param  line: assert_param error line source number
  * @retval None
  */
void assert_failed(uint8_t *file, uint32_t line)
{
  /* USER CODE BEGIN 6 */
  /* User can add his own implementation to report the file name and line number,
     ex: printf("Wrong parameters value: file %s on line %d\r\n", file, line) */
  /* USER CODE END 6 */
}
#endif /* USE_FULL_ASSERT */

/************************ (C) COPYRIGHT STMicroelectronics *****END OF FILE****/
